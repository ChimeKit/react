import * as React from "react";
import ChimeKit from "./ChimeKit";

const POWERED_BY_SVG = `<svg width="1.5em" height="1.5em" viewBox="0 0 75 75" style="vertical-align:middle;">
  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    <g transform="translate(38.000000, 39.000000) rotate(-20.000000) translate(-38.000000, -39.000000) translate(10.000000, 6.000000)" fill="#2563EB" fill-rule="nonzero">
      <path d="M27.9076677,4.08642418e-13 C30.9548671,4.08642418e-13 33.4955891,2.14314583 34.0708481,4.98750237 C41.5497704,7.75735156 46.9049947,15.4331748 47.0655573,24.4308735 L47.0687114,24.770431 L47.0759092,24.8941806 C47.4145065,30.389301 49.4935472,35.9473426 53.3550509,41.5870265 L53.7222902,42.1159866 L53.9133607,42.3867847 C56.0372415,45.4414123 55.8864367,48.4735207 53.4970662,50.6959546 C52.1753471,51.9253301 50.2487719,52.8366854 47.7601374,53.5280544 L47.3151407,53.647797 L47.0330897,53.7198755 L46.9618791,53.7376307 L46.8903898,53.7552811 L46.601649,53.8248431 C46.2136958,53.9164916 45.8138914,54.0037618 45.4023691,54.0869591 C43.5915615,54.4530495 41.7061124,54.7245059 39.7143771,54.9217088 L39.6785281,54.9242807 C39.3771304,61.0913793 34.222424,66 27.9076677,66 C21.5929427,66 16.4382562,61.0914279 16.1368118,54.9243724 L16.9610565,55.0017376 C14.6494461,54.8001335 12.4824607,54.5053482 10.4129664,54.0869591 C10.1386182,54.0314942 9.86947794,53.9742192 9.60558513,53.9150435 L9.21368642,53.8248431 L8.92494566,53.7552811 L8.78224575,53.7198755 L8.50019471,53.647797 C5.79531237,52.9428032 3.71773655,51.9976463 2.31826924,50.6959546 C-0.0317229688,48.5101477 -0.216327333,45.5411343 1.79881961,42.537789 L1.96703108,42.2942141 L2.09304523,42.1159866 C6.10653421,36.4135817 8.29965771,30.7950909 8.71573486,25.2412139 L8.7465839,24.7702608 L8.74861528,24.5020334 C8.88216002,15.4652843 14.2519947,7.76319179 21.7452588,4.98641851 C22.3201287,2.14282337 24.8606976,4.08642418e-13 27.9076677,4.08642418e-13 Z M34.9203095,55.2540261 L34.6716911,55.2646267 L34.1864883,55.2837533 L33.69691,55.301043 L33.4504562,55.3090143 L33.2028801,55.3165448 L32.7043224,55.3303076 L32.2011609,55.3423806 L31.6933195,55.3528127 L31.180722,55.361653 L30.6632924,55.3689504 L30.5331711,55.3705395 L30.4027418,55.3720359 L29.8779212,55.377111 L29.0812495,55.382076 L28.2730205,55.3840108 L27.2702698,55.3840108 L26.7328572,55.3820756 L26.4660797,55.3807655 L25.9363348,55.3771107 L25.8046855,55.375977 L25.6733484,55.3747538 L25.1511003,55.3689502 L24.633755,55.3616527 L24.1212367,55.3528125 L23.6134695,55.3423804 L23.1103773,55.3303074 L22.6118842,55.3165446 L22.3643387,55.3090141 L22.1179144,55.3010429 L21.6283918,55.2837532 L21.1432405,55.2646266 L20.8949401,55.2533669 C21.3419076,58.6876133 24.3112363,61.341272 27.9076677,61.341272 C31.503869,61.341272 34.4730478,58.6879529 34.9203095,55.2540261 Z M27.9060973,8.54105831 L27.6706409,8.54330127 C19.9616129,8.68439554 13.6223044,15.6953209 13.4630508,24.5072786 L13.4599832,24.8470775 L13.4599832,24.9102994 L13.4448024,25.1745142 C13.0483122,31.6204643 10.6252651,38.0383649 6.21921248,44.4088121 L5.82529803,44.9707868 L5.78011055,45.0350874 C5.29234106,45.7367384 5.1101321,46.2518767 5.12444498,46.5913277 C5.13351843,46.8065179 5.24261992,47.0184752 5.54897654,47.3034278 C5.82675681,47.5618006 6.20586899,47.8139466 6.67890425,48.0560241 L6.92321451,48.1762061 L7.07287602,48.2454948 L7.18854724,48.2970501 L7.3071351,48.3482429 L7.46975945,48.4159206 L7.5529918,48.4495052 L7.63749746,48.4829169 L7.81030827,48.5492105 L7.94322082,48.5984569 L8.07894662,48.6472871 L8.2642607,48.7117315 L8.55146249,48.8069348 L8.8496185,48.900319 L9.05440678,48.961529 L9.26396148,49.0218776 L9.31709012,49.0368276 L9.37051347,49.0517222 L9.5871412,49.1107387 L9.64202853,49.1253508 L9.69720674,49.1399054 L9.9208156,49.1975423 L10.1490275,49.2542329 L10.2067949,49.2682552 L10.2648468,49.2822168 L10.4998866,49.3374483 L10.7394273,49.3916806 L10.9834281,49.4448926 L11.0451203,49.4580337 L11.1070882,49.4711093 L11.3577024,49.5227509 C12.6886658,49.7918314 14.0827363,50.0062366 15.5496526,50.1749739 L16.2892263,50.2555785 L16.7087915,50.2974858 L17.1322965,50.3371285 L17.5597888,50.3745507 L17.775045,50.3924428 L17.9913158,50.4097962 L18.4269251,50.4429091 L18.6462754,50.4586795 L19.0880971,50.4886757 L19.3105804,50.5029125 L19.7587215,50.529891 L19.9843912,50.5426436 L20.2111349,50.5549125 L20.6678681,50.578021 L21.1289686,50.5992605 L21.5944839,50.6186748 L21.7115581,50.6232484 L21.8289119,50.6277113 L22.3011385,50.6444704 L22.4199017,50.6483905 L22.5389489,50.652204 L23.0179937,50.6664067 L23.5016433,50.67896 L23.7452097,50.6846319 L24.2358557,50.6947936 L24.7312252,50.7034157 L25.2313658,50.7105424 L25.7363251,50.7162174 L26.2461504,50.7204847 L26.7608894,50.7233883 L27.5423149,50.7252832 L28.5334112,50.7252832 L29.0532195,50.7233887 L29.5680606,50.720485 L30.0779823,50.7162177 L30.5830322,50.7105427 L31.083258,50.703416 L31.5787074,50.6947938 L31.701829,50.6923994 L31.8246558,50.6899081 L32.3130299,50.6789602 L32.7967468,50.6664068 L33.2758542,50.6522041 L33.5136941,50.6444706 L33.9859765,50.6277114 L34.1033436,50.6232485 L34.2204309,50.6186749 L34.6859956,50.5992606 L35.1471415,50.5780211 L35.6039162,50.5549126 L35.8306793,50.5426437 L36.0563675,50.529891 L36.5045429,50.5029126 L36.6159242,50.4958571 L36.7270421,50.4886758 L37.1688932,50.4586796 L37.3882571,50.4429092 L37.8238911,50.4097963 L38.0401733,50.3924428 L38.2554401,50.3745507 L38.6829517,50.3371286 L38.8952084,50.3175875 L39.1064735,50.2974858 L39.5260533,50.2555786 C41.0175699,50.1018137 42.4345766,49.9038822 43.7868472,49.6527766 L44.457633,49.5227509 L44.7082473,49.4711093 L44.8319074,49.4448926 L44.9544627,49.4184155 L45.1962386,49.3646907 L45.3154489,49.3374483 L45.4335339,49.3099561 L45.666308,49.2542329 L45.9508552,49.1832209 L46.0069022,49.1688408 L46.2281942,49.1107387 L46.444822,49.0517222 L46.4982453,49.0368276 L46.551374,49.0218776 L46.7609287,48.961529 L46.965717,48.900319 L47.0663109,48.8693975 L47.165698,48.8382686 L47.3608308,48.775399 L47.4565665,48.7436636 L47.5510747,48.7117315 L47.7363888,48.6472871 L47.8721146,48.5984569 L48.0050272,48.5492105 L48.177838,48.4829169 L48.4680259,48.365225 L48.7424594,48.2454948 L48.8921209,48.1762061 C49.480281,47.8978223 49.9422819,47.6048627 50.2663589,47.3034278 C50.5727155,47.0184752 50.681817,46.8065179 50.6908905,46.5913277 C50.7044082,46.2707351 50.5426333,45.7934337 50.1137092,45.1503041 L49.9900374,44.9707868 L49.849599,44.7721372 C45.3681538,38.4035015 42.8688858,31.9870435 42.3953469,25.5421671 L42.3588222,24.9734283 L42.3553523,24.9102994 L42.3553523,24.8470775 C42.3553523,15.999154 36.1201651,8.86639389 28.4388298,8.55196513 L28.1426908,8.54324457 L27.9060973,8.54105831 Z"></path>
      <path d="M45.3610109,3.42429627 C46.0488672,2.59533267 47.2864533,2.47441424 48.1252369,3.15421742 C52.7538683,6.90555239 55.0810155,12.1203842 55.0810155,18.6317591 C55.0810155,19.7038192 54.2016438,20.5728957 53.1168839,20.5728957 C52.0321239,20.5728957 51.1527523,19.7038192 51.1527523,18.6317591 C51.1527523,13.2476486 49.3218189,9.14476697 45.6342892,6.15616019 C44.7955056,5.47635702 44.6731547,4.25325988 45.3610109,3.42429627 Z" transform="translate(49.998295, 11.643445) rotate(-6.000000) translate(-49.998295, -11.643445)"></path>
      <path d="M1.36442192,3.42429627 C2.05227813,2.59533267 3.28986423,2.47441424 4.12864785,3.15421742 C8.75727925,6.90555239 11.0844265,12.1203842 11.0844265,18.6317591 C11.0844265,19.7038192 10.2050548,20.5728957 9.12029484,20.5728957 C8.03553491,20.5728957 7.15616323,19.7038192 7.15616323,18.6317591 C7.15616323,13.2476486 5.32522988,9.14476697 1.63770016,6.15616019 C0.798916544,5.47635702 0.676565706,4.25325988 1.36442192,3.42429627 Z" transform="translate(6.001705, 11.643445) scale(-1, 1) rotate(-6.000000) translate(-6.001705, -11.643445)"></path>
    </g>
  </g>
</svg>`;

const POWERED_BY_CSS = `
  a {
    display: inline-flex;
    align-items: center;
    gap: var(--chimekit-space-1, 0.25rem);
    font-family: var(--chimekit-font-sans, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji");
    font-size: var(--chimekit-font-size-xs, 0.75rem);
    line-height: var(--chimekit-leading-snug, 1.375);
    color: var(--chimekit-message-details-muted, var(--chimekit-feed-muted, var(--chimekit-muted, #71717a)));
    text-decoration: none;
  }

  a:hover {
    color: var(--chimekit-message-details-accent, var(--chimekit-accent, #2563eb));
  }

  svg {
    display: inline-block;
  }
`;

export type PoweredByFooterProps = {
  className?: string;
  style?: React.CSSProperties;
  slotPrefix?: string;
  noWrapper?: boolean;
};

export function PoweredByFooter({
  className,
  style,
  slotPrefix = "chimekit",
  noWrapper = false,
}: PoweredByFooterProps) {
  const footerSlot = `${slotPrefix}-footer`;
  const textSlot = `${slotPrefix}-footer-text`;
  const hostRef = React.useRef<HTMLSpanElement | HTMLDivElement>(null);
  const shadowRef = React.useRef<ShadowRoot | null>(null);
  const fallbackLinkStyle: React.CSSProperties = {
    display: "inline-flex",
    alignItems: "center",
    gap: "0.25rem",
  };

  React.useEffect(() => {
    const host = hostRef.current;
    if (!host || typeof host.attachShadow !== "function") {
      return;
    }

    if (shadowRef.current && shadowRef.current.host !== host) {
      shadowRef.current = null;
    }

    if (!shadowRef.current) {
      shadowRef.current = host.attachShadow({ mode: "closed" });
    }

    // Shadow root keeps host app CSS from reaching the branding link.
    const shadow = shadowRef.current;
    if (!shadow) {
      return;
    }

    host.style.setProperty("display", noWrapper ? "inline-flex" : "flex", "important");
    host.style.setProperty("align-items", "center", "important");
    host.style.setProperty("visibility", "visible", "important");
    host.style.setProperty("opacity", "1", "important");
    host.style.setProperty("transform", "none", "important");

    const styleEl = document.createElement("style");
    styleEl.textContent = POWERED_BY_CSS;

    const linkEl = document.createElement("a");
    linkEl.href = "https://chimekit.com";
    linkEl.target = "_blank";
    linkEl.rel = "noopener noreferrer";
    linkEl.setAttribute("data-chimekit-slot", textSlot);
    linkEl.setAttribute("data-chimekit-powered", "true");
    linkEl.innerHTML = `Powered by ChimeKit ${POWERED_BY_SVG}`;

    shadow.innerHTML = "";
    shadow.append(styleEl, linkEl);
  }, [noWrapper, textSlot]);

  const link = (
    <a
      href="https://chimekit.com"
      target="_blank"
      rel="noopener noreferrer"
      data-chimekit-slot={textSlot}
      data-chimekit-powered="true"
      style={fallbackLinkStyle}
    >
      Powered by ChimeKit <ChimeKit />
    </a>
  );

  if (noWrapper) {
    return (
      <span
        ref={hostRef}
        className={className}
        style={style}
        data-chimekit-slot={textSlot}
        data-chimekit-powered="true"
      >
        {link}
      </span>
    );
  }

  return (
    <div
      ref={hostRef as React.RefObject<HTMLDivElement>}
      className={className}
      style={style}
      data-chimekit-slot={footerSlot}
      data-chimekit-powered="true"
    >
      {link}
    </div>
  );
}
